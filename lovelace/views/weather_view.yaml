anchors:
  style_entitycard_header: &style_header
    card_mod: 
      style: |
        .card-header {
          font-size: 20px;
          padding: 10px 16px;
        }

#---------------------------------
title: Wetter
path: weather
icon: mdi:weather-partly-cloudy
cards:
  # current weather info and forcast
  - type: custom:weather-chart-card
    title: #Woche (DWD)
    entity: weather.dwd_weather_ak_stuttgart
    show_main: true
    show_attributes: true
    units:
      #pressure: mmHg
      speed: km/h
    locale: 'de-DE'
    style: |
      .card-header {
        padding: 20px 16px 10px;
        line-height: 32px;
      }

  # show weather alerts (if current_warn_count > 0)
  - type: conditional
    conditions:
      - entity: sensor.dwd_current_warn_count
        state_not: '0'
    card:
      type: custom:vertical-stack-in-card
      #title: Deutscher Wetterdienst  #title is too big here...
      cards:
        # show warning count and status received from DWD
        - type: custom:fold-entity-row
          head:
            type: section
            label: Wetterwarnungen & Alarm
          open: false
          entities:
            - entity: sensor.dwd_current_warn_count
              type: custom:multiple-entity-row
              name: DWD Meldungen aktuell
              secondary_info: last-changed
              entities:
              - entity: sensor.dwd_current_warn_level
                name: DWD lvl
              - entity: sensor.dwd_max_warn_level
                name: max lvl
            - entity: sensor.dwd_current_warn_gewitter 
              type: custom:multiple-entity-row
              name: Gewitter-Warnung
              icon: mdi:weather-lightning-rainy
              entities:
              - entity: sensor.dwd_current_warn_level_gewitter
                name: Level
            - entity: sensor.dwd_current_warn_sturm 
              type: custom:multiple-entity-row
              name: Sturm-Warnung
              icon: mdi:weather-windy
              entities:
              - entity: sensor.dwd_current_warn_level_sturm
                name: Level
            - entity: sensor.dwd_current_warn_regen
              type: custom:multiple-entity-row
              name: Regen-Warnung
              icon: mdi:weather-pouring
              entities:
              - entity: sensor.dwd_current_warn_level_regen
                name: Level            
            - entity: sensor.dwd_current_warn_hagel
              type: custom:multiple-entity-row
              name: Hagel-Warnung
              icon: mdi:weather-hail
              entities:
              - entity: sensor.dwd_current_warn_level_hagel
                name: Level
            - entity: sensor.dwd_current_warn_schnee
              type: custom:multiple-entity-row
              name: Schnee-Warnung
              icon: mdi:weather-snowy-heavy
              entities:
              - entity: sensor.dwd_current_warn_level_schnee
                name: Level
            - entity: sensor.dwd_current_warn_frost
              type: custom:multiple-entity-row
              name: Frost-Warnung
              icon: mdi:thermometer-alert
              entities:
              - entity: sensor.dwd_current_warn_level_frost
                name: Level
            - entity: sensor.dwd_current_warn_glaette
              type: custom:multiple-entity-row
              name: Glatteis-Warnung
              icon: mdi:snowflake-alert
              entities:
              - entity: sensor.dwd_current_warn_level_glaette
                name: Level
            - entity: input_boolean.dwd_weather_alert
              type: custom:multiple-entity-row
              name: Wetter Alarm
              secondary_info: last-changed
              entities:
              - entity: sensor.count_notification_alerts
                name: Anz. Alarme

        # show the text of all DWD warnings
        - type: divider
        - type: markdown
          card_mod:
            style: |
              ha-card {
                border: 0px solid green;
              }
          content: >
              <h3>{{ state_attr('sensor.dwd_weather_warnings_current_warning_level','region_name') }}</h3>
              Aktuell 
              {% if states('sensor.dwd_current_warn_count')|int == 1 %}
                besteht {{ states('sensor.dwd_current_warn_count') }} Warnung 
              {% else %}
                bestehen {{ states('sensor.dwd_current_warn_count') }} Warnungen 
              {% endif %}
              mit der maximalen Stufe {{ states('sensor.dwd_max_warn_level') }}.
              {%- for i in range(0, state_attr('sensor.dwd_weather_warnings_current_warning_level','warning_count')) -%}
                {%- set type_attr=  "warning_"+loop.index|string + "_type" -%}
                {%- set lvl_attr=   "warning_"+loop.index|string + "_level" -%}
                {%- set head_attr=  "warning_"+loop.index|string + "_headline" -%}
                {%- set start_attr= "warning_"+loop.index|string + "_start" -%}
                {%- set end_attr=   "warning_"+loop.index|string + "_end" -%}
                {%- set desc_attr=  "warning_"+loop.index|string + "_description" -%}
                <hr/>
                <em>
                {%- set start_time= state_attr('sensor.dwd_weather_warnings_current_warning_level',start_attr) -%}
                {%- set days = (start_time.strftime('%j') | int) - (now().strftime('%j')) | int  -%}
                {% if as_timestamp(start_time) <= as_timestamp(now()) %}
                jetzt
                {% elif days==0 %}
                heute
                {% elif days==1 %}
                morgen
                {% else %}
                in {{days}} Tagen
                {% endif %}
                </em>
                <h3>{{ state_attr('sensor.dwd_weather_warnings_current_warning_level',head_attr) }}</h3>
                <em>Warnstufe:</em> <strong>{{ state_attr('sensor.dwd_weather_warnings_current_warning_level',lvl_attr) }}</strong>
                <br>
                <em>Von:</em> {{ as_timestamp(state_attr('sensor.dwd_weather_warnings_current_warning_level',start_attr)) | timestamp_custom('%a %d.%m %H:%M',true) }}
                <br>
                <em>Bis:</em> {{ as_timestamp(state_attr('sensor.dwd_weather_warnings_current_warning_level',end_attr)) | timestamp_custom('%a %d.%m %H:%M',true) }}
                <br>
                {{ state_attr('sensor.dwd_weather_warnings_current_warning_level',desc_attr) }}
                <br>
                <br>
              {%- endfor -%}

  # MeteoBlue Meteogram
  - type: picture
    image: !secret meteogram_image
    tap_action:
      action: url
      url_path: !secret meteogram_url

  # Sonnenstand und Sonnenschein
  - type: entities
    title: Sonnenstand & -schein
    show_header_toggle: false
    <<: *style_header
    entities:
      - entity: weather.dwd_weather_ak_stuttgart
        name: Temperatur (DWD)
      - type: section
        label: Sonnenstand
      - entity: sensor.sun_elevation
        type: custom:multiple-entity-row
        name: Azimut
        icon: mdi:weather-sunset #.orbit
        state_header: Höhe
        entities:
        - entity: sensor.sun_direction
          name: Richtung
      - entity: sun.sun
        icon: mdi:theme-light-dark
      - type: section
        label: Sonnenschein
      - entity: sensor.sun_is_shining
      - entity: sensor.sunshine_intensity

  # 3 different satelite pictures (rain, clouds, snow); can be toggled by tapping on them. 
  - type: custom:vertical-stack-in-card
    cards:
    - type: conditional
      conditions:
        - entity: input_select.type_of_satelite  #value stored the current selection
          state: "Bewölkung"
      card:
        type: picture-entity
        entity: camera.satelite_clouds
        name: Bewölkung #clouds
        show_state: false
        tap_action:
          action: call-service
          service: input_select.select_next
          service_data:
            entity_id: input_select.type_of_satelite
    - type: conditional
      conditions:
        - entity: input_select.type_of_satelite
          state: "Regen"
      card:
        type: picture-entity
        entity: camera.satelite_rain
        name: Regen #rain
        show_state: false
        tap_action:
          action: call-service
          service: input_select.select_next
          service_data:
            entity_id: input_select.type_of_satelite            
    - type: conditional
      conditions:
        - entity: input_select.type_of_satelite
          state: "Schnee"
      card:
        type: picture-entity
        entity: camera.satelite_snow
        name: Schnee #snow
        show_state: false
        tap_action:
          action: call-service
          service: input_select.select_next
          service_data:
            entity_id: input_select.type_of_satelite
  #test
  #  - type: glance
  #    title: Auswahl
  #    entities:
  #      - entity: input_select.type_of_satelite